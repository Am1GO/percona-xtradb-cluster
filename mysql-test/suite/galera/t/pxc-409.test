# PXC-409
# lp:1464468 Slave crash with malformed binlog event: Test with galera

--source include/have_innodb.inc
--source include/galera_cluster.inc
--source include/have_debug.inc
--source include/have_binlog_format_row.inc

--disable_warnings
DROP TABLE IF EXISTS `t`;
--enable_warnings

--connection node_1
CREATE TABLE `t` (
  `f1` int(10) unsigned NOT NULL,
  PRIMARY KEY (`f1`)
) ENGINE=InnoDB;

--disable_warnings
DROP TRIGGER IF EXISTS t_insert_trig;
--enable_warnings

INSERT INTO t VALUES (1), (2), (3), (4), (5), (6), (7), (8), (9), (10);

--delimiter |
CREATE TRIGGER t_insert_trig AFTER INSERT ON t
	FOR EACH ROW
		BEGIN

      DECLARE EXIT HANDLER FOR SQLEXCEPTION
	    BEGIN
		  ROLLBACK TO savepoint_1;
# If the bug is not fixed then debug build will crash here with assertion.
	    END;

		  SAVEPOINT savepoint_1;

      INSERT INTO dummy VALUES (1);

		END |
--delimiter ;

INSERT INTO t VALUES (11), (12), (13), (14), (15), (16), (17), (18), (19), (20);
INSERT INTO t VALUES (21), (22), (23), (24), (25), (26), (27), (28), (29), (30);


--connection node_2
SELECT COUNT(*) = 30 FROM t;

--connection node_1
DROP TABLE `t`;

--connection node_1
--source include/show_binlog_events.inc
--connection node_2
--source include/show_binlog_events.inc
